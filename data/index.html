<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Concentración en Tiempo Real</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Sistema de Monitoreo de Concentración</h1>

    <!-- FORMULARIO -->
    <div id="formulario">
      <h2>Iniciar sesión de estudio</h2>
      <form id="startForm">
        <label>Nombre:<br><input type="text" name="nombre" required></label><br>
        <label>Materia:<br><input type="text" name="materia" required></label><br>
        <label>Tiempo (min):<br><input type="number" name="tiempo" min="1" max="180" value="25" required></label><br>
        <button type="submit">Iniciar</button>
      </form>
    </div>

    <!-- MONITOR -->
    <div id="monitor" style="display:none;">
      <h2>Sesión en progreso</h2>
      <p><strong>Tiempo restante:</strong> <span id="timer">--:--</span></p>
      <h3>Estadísticas:</h3>
      <ul>
        <li>Temperatura: <span id="temperatura">--°C</span></li>
        <li>Nivel de luz: <span id="luz">--</span></li>
        <li>Total distracciones: <span id="distracciones">0</span></li>
      </ul>
      <button id="btnDetener">Detener sesión</button>
    </div>
  </div>

  <script>
    const form    = document.getElementById('startForm');
    const contForm= document.getElementById('formulario');
    const contMon = document.getElementById('monitor');
    const timerEl = document.getElementById('timer');
    const tempEl  = document.getElementById('temperatura');
    const luzEl   = document.getElementById('luz');
    const distEl  = document.getElementById('distracciones');
    const btnDet  = document.getElementById('btnDetener');

    form.addEventListener('submit', e => {
      e.preventDefault();
      const data = new URLSearchParams(new FormData(form));
      fetch('/iniciar', { method: 'POST', body: data })
        .then(() => {
          contForm.style.display = 'none';
          contMon.style.display  = 'block';
        });
    });

    btnDet.addEventListener('click', () => {
      location.reload();
    });

    function segToMMSS(sec) {
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = (sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function actualizar() {
      fetch('/datos')
        .then(r => r.json())
        .then(d => {
          if (!d.sesionActiva) {
            alert('¡Sesión completada!');
            location.reload();
            return;
          }
          timerEl.textContent = segToMMSS(d.tiempoRestante);
          tempEl.textContent  = d.temperatura.toFixed(1) + '°C';
          luzEl.textContent   = d.luz;
          distEl.textContent  = d.distracciones;
        })
        .catch(console.error);
    }

    setInterval(actualizar, 1000);
  </script>
</body>
</html>
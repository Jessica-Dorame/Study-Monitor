<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache‑Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma"       content="no-cache">
  <meta http-equiv="Expires"      content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Monitoreo</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Monitoreo de Concentración</h1>

    <div class="card">
      <p><strong>Estudiante:</strong> <span id="nombre">%NOMBRE%</span></p>
      <p><strong>Materia:</strong>    <span id="materia">%MATERIA%</span></p>
    </div>

    <div class="card timer">
      <span id="minutos">--</span>:<span id="segundos">--</span>
      <div class="progress-bar"><div id="progress"></div></div>
    </div>

    <div class="card stats">
      <p>Temperatura: <span id="temperatura">--°C</span></p>
      <p>Luz:         <span id="luz">--</span></p>
      <p>Distracciones: <span id="distracciones">0</span></p>
    </div>

    <form action="/detener" method="POST">
      <button type="submit">Detener sesión</button>
    </form>
  </div>

  <script>
    // Inicialización
    let tiempoInicial = parseInt("%TIEMPO_DESEADO%")*60;
    let tiempoInicio   = Date.now();

    function actualizarCrono(rest){
      const m = Math.floor(rest/60), s = rest%60;
      document.getElementById('minutos').textContent = String(m).padStart(2,'0');
      document.getElementById('segundos').textContent = String(s).padStart(2,'0');
      const pct = 100 - (rest/tiempoInicial)*100;
      document.getElementById('progress').style.width = pct+'%';
    }

    function obtenerDatos(){
      fetch('/datos')
        .then(r=> r.json())
        .then(d=>{
          if(!d.sesionActiva){
            window.location = '/resultados';
            return;
          }
          const rest = Math.floor(d.tiempoRestante/1000);
          actualizarCrono(rest);
          document.getElementById('temperatura').textContent = d.temperatura.toFixed(1)+'°C';
          document.getElementById('luz').textContent         = d.luz;
          document.getElementById('distracciones').textContent = d.totalDistracciones;
        })
        .catch(console.error);
    }

    setInterval(obtenerDatos, 1000);
    window.onload = obtenerDatos;
  </script>
</body>
</html>